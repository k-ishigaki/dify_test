# Repository Guidelines

このリポジトリは Dify 向けの Knowledge Base Document Preprocessor プラグインです。入出力の安定性が重要なため、貢献者は以下の方針に従って開発・レビューを進めてください。

## プロジェクト構成とモジュール配置
- `tools/knowledge-base-document-preprocessor.py`: Markdown 正規化とチャンク分割の中核ロジック。データパス生成やテーブル JSON 化もここに集約し、分岐条件が多いので変更時はテスト必須。
- `provider/knowledge-base-document-preprocessor.yaml` と `manifest.yaml`: プラグイン定義とメタデータ。Runner は Python 3.12 で `main.py` がエントリーポイント。Dify の設定変更はここに反映する。
- `test_split_and_prefix.py` と `test.md`: チャンク分割の期待動作を固定する pytest スイートと入力例。回帰確認はこの組み合わせで行う。
- ドキュメントは `README.md` と `GUIDE.md`、アセットは `_assets/` 配下。必要に応じて `PRIVACY.md` も更新する。

## ビルド・テスト・開発コマンド
- 依存関係: `python -m venv .venv && source .venv/bin/activate` 後に `pip install -r requirements.txt`。CI がないためローカルで確実に再現する。
- ローカル実行: `.env` を整備したうえで `python -m main` を実行するとプラグインデーモンが起動し、Dify のデバッグモードと接続できる。
- テスト: `pytest test_split_and_prefix.py`。分割ロジックを改修したら必ず実行し、エッジケースを追加する。
- パッケージング: リリース前に `dify-plugin plugin package .` で `.difypkg` を生成し、成果物を確認。
- フォーマットや型チェックの専用スクリプトは未導入のため、PEP 8 と型ヒントを意識し、気になる箇所は `python -m compileall tools` などで軽く静的検証する。

## コーディングスタイルと命名
- Python 4 スペースインデント、関数・変数はスネークケース、クラスはパスカルケースで統一。引数と戻り値には型ヒントを付与する。
- ロガーは既存の `plugin_logger_handler` を再利用し、標準出力への追加ハンドラは避ける。例外は logger で捕捉して文脈を残す。
- `_split_and_prefix` 周辺は単一責務を保ち、ヘルパー関数を追加する場合もテストを添付する。分割ポリシーが変わる場合はコメントで根拠を残す。
- 文字列リテラルはシングルクォート基調で統一し、定数は全大文字のスネークケース。再利用する正規表現や境界値は定数化する。

## テスト方針
- フレームワークは pytest。新規ケースは `test_*` 関数名で追加し、`test.md` に対応する入力を最小限追記する。入力が大きい場合はサンプルを縮約して意図を記述する。
- 期待するチャンク境界や data-path のシーケンスは配列で明示し、副作用のない pure function を優先して検証する。テーブル変換やエンコーディングも個別に確認する。
- バグ再現テストは先に落ちる形で書き、修正後も残して退行検知に使う。再現手順が複数ある場合は parametrize でまとめる。

## コミットとプルリクエスト
- コミットメッセージは Git 履歴に倣い、短い命令形のサマリ（例: `Update chunk split rule`）を先頭行に記載。WIP は避け、1 コミット 1 目的を心掛ける。
- PR には概要、影響範囲、動作確認手順（実行したコマンドと結果）を箇条書きで添付し、関連 Issue があればリンクする。期待する挙動の前後比較があるとレビューが速い。
- 仕様や入出力を変える場合は `README.md` か `GUIDE.md` を更新し、レビュアーが差分の意図を追えるように説明する。必要なら簡単なサンプル入出力を併記する。

## セキュリティと設定の注意
- `.env` など秘匿情報はコミットしない。MarkItDown の一時ファイルはコード内で削除しているが、追加の一時出力を作る場合は必ずクリーンアップを実装する。
- Dify の接続情報は環境変数経由で注入し、デバッグ用のキーはレビュー完了後に無効化する。
- 外部依存を増やす場合はライセンスとサイズを確認し、`requirements.txt` にピン留めして再現性を確保する。実行時メモリ枠（manifest の 256MB）も意識する。
- 開発環境は local / staging / production を分離し、本番シークレットをローカルテストで使わない。
